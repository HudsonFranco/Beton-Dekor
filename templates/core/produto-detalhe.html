{% extends 'base.html' %}
{% load static %}

{% block title %}{{ produto.nome }} - BetonDekor{% endblock %}


{% block content %}
<!-- Header -->
{% include 'core/_header.html' %}

<!-- Main Product Display Section -->
<main id="product-detail-section" class="product-detail-main">
    <!-- Back Button -->
    <div class="back-button-container">
        <a href="{% url 'produtos' %}"
           hx-get="{% url 'produtos' %}"
           hx-target="body"
           hx-swap="outerHTML"
           hx-push-url="true"
           class="back-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Voltar para Produtos
        </a>
    </div>

    <div class="product-detail-container">
        <!-- Product Image Area: support up to 3 images as a simple carousel -->
        <div id="product-image-section" class="product-image-area">
            {% with imagens=produto.get_imagens_urls %}
                {% if imagens %}
                    <div class="product-image-carousel">
                        {% for url in imagens %}
                            <img src="{{ url }}" alt="{{ produto.nome }} - {{ forloop.counter }}" class="product-modern-image product-image-slide" data-index="{{ forloop.counter0 }}">
                        {% endfor %}
                    </div>
                {% else %}
                    <div style="color: #999; font-family: 'Montserrat'; font-size: 18px;">Sem imagem</div>
                {% endif %}
            {% endwith %}

            <!-- Carousel arrows (reuse existing buttons) -->
            <button class="carousel-arrow carousel-arrow-left" aria-label="Anterior" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(38, 38, 38, 0.8); border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="carousel-arrow carousel-arrow-right" aria-label="Próximo" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(38, 38, 38, 0.8); border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>

        <!-- Product Information -->
        <div class="product-info-area">
            <p class="product-category-tag" style="font-family: 'Montserrat'; font-weight: 400; font-size: 14px; color: #999; margin-bottom: 16px;">
                {% if produto.categoria %}({{ produto.categoria }}){% endif %}
            </p>
            
            <h1 class="product-detail-title">
                {{ produto.nome }}
            </h1>

            {% if produto.dimensoes %}
            <p class="product-dimensions" style="font-family: 'Montserrat'; font-weight: 400; font-size: 16px; color: #262626; margin-bottom: 32px;">
                <strong style="font-weight: 700;">Dimensões:</strong> {{ produto.dimensoes }}
            </p>
            {% endif %}

            <div class="product-specifications" style="margin-bottom: 40px;">
                <ul style="list-style: none; padding: 0; margin: 0;">
                    {% if produto.categoria %}
                    <li style="font-family: 'Montserrat'; font-weight: 400; font-size: 16px; color: #262626; margin-bottom: 12px;">
                        <strong style="font-weight: 700;">Categoria:</strong> {{ produto.categoria }}
                    </li>
                    {% endif %}
                    {% if produto.categoria_principal %}
                    <li style="font-family: 'Montserrat'; font-weight: 400; font-size: 16px; color: #262626; margin-bottom: 12px;">
                        <strong style="font-weight: 700;">Categoria Principal:</strong> {{ produto.categoria_principal }}
                    </li>
                    {% endif %}
                    {% if produto.cor %}
                    <li style="font-family: 'Montserrat'; font-weight: 400; font-size: 16px; color: #262626; margin-bottom: 12px;">
                        <strong style="font-weight: 700;">Cor:</strong> {{ produto.cor }}
                    </li>
                    {% endif %}
                    {% if produto.unidade_venda %}
                    <li style="font-family: 'Montserrat'; font-weight: 400; font-size: 16px; color: #262626; margin-bottom: 12px;">
                        <strong style="font-weight: 700;">Unidade de Venda:</strong> {{ produto.unidade_venda }}
                    </li>
                    {% endif %}
                    {% if produto.especificacoes %}
                    <li style="font-family: 'Montserrat'; font-weight: 400; font-size: 16px; color: #262626; margin-bottom: 12px;">
                        <strong style="font-weight: 700;">Especificação:</strong> {{ produto.especificacoes }}
                    </li>
                    {% endif %}
                </ul>
            </div>

            <a href="#" class="contact-button-main" onclick="openContactModal(); return false;" style="display: inline-block; padding: 14px 32px; background: #262626; color: white; border-radius: 45px; text-decoration: none; font-family: 'Montserrat'; font-weight: 600; font-size: 16px; text-align: center; max-width: 250px;">
                Entre em Contato
            </a>
        </div>
    </div>
</main>

<!-- Other Products Section -->
<section class="other-products-section" style="background: #f7f7f7; padding: 80px 116px;">
    <h2 class="other-products-title" style="text-align: center; font-family: 'Montserrat'; font-weight: 400; font-size: 40px; color: #262626; margin-bottom: 60px;">
        <span style="font-weight: 400;">OUTROS</span> <strong style="font-weight: 700;">PRODUTOS</strong>
    </h2>
    
    <div class="other-products-grid">
        {% for outro_produto in outros_produtos %}
        <a href="{% url 'produto-detalhe' outro_produto.slug %}" 
           hx-get="{% url 'produto-detalhe' outro_produto.slug %}"
           hx-target="body"
           hx-swap="outerHTML"
           hx-push-url="true"
           class="product-card-wrapper product-card-link"
           style="text-decoration: none; color: inherit;">
            <div class="product-card-modern" style="background: #ffffff; border-radius: 12px; padding: 16px 16px 18px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; display: flex; flex-direction: column; gap: 10px; transition: box-shadow 0.2s ease;">
                <p class="product-tag" style="margin: 0; font-family: 'Montserrat'; font-weight: 600; font-size: 10px; color: #c5c5c5;">{{ outro_produto.tag }}</p>
                {% if outro_produto.get_imagem_url %}
                    <img src="{{ outro_produto.get_imagem_url }}" alt="{{ outro_produto.nome }}" class="product-modern-image" style="max-width: 185px; width: 100%; height: auto; margin: 0 auto; object-fit: contain;">
                {% else %}
                    <div class="product-modern-image" style="background: #f0f0f0; height: 150px; display: flex; align-items: center; justify-content: center; color: #999; font-family: 'Montserrat'; font-size: 12px;">Sem imagem</div>
                {% endif %}
                <h3 class="product-modern-name" style="font-family: 'Montserrat'; font-weight: 700; font-size: 15px; color: #262626; margin: 0;">{{ outro_produto.nome }}</h3>
                <p class="product-meta" style="margin: -4px 0 4px; font-family: 'Montserrat'; font-weight: 600; font-size: 10px; color: #9a9a9a; line-height: 1.4;">
                    {% if outro_produto.categoria_principal %}{{ outro_produto.categoria_principal }}{% endif %}
                    {% if outro_produto.categoria %}({{ outro_produto.categoria }}){% endif %}
                </p>
                <button class="pill-button" style="display: inline-flex; align-items: center; justify-content: center; padding: 10px 20px; background: #0f0f0f; color: #fff; border: none; border-radius: 999px; font-family: 'Montserrat'; font-weight: 600; font-size: 12px; cursor: pointer; width: 100%; margin-top: 8px; transition: opacity 0.2s ease;">Ver detalhes</button>
            </div>
        </a>
        {% empty %}
        <p style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999; font-family: 'Montserrat';">Nenhum outro produto disponível.</p>
        {% endfor %}
    </div>
</section>

<!-- Footer -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-left">
            <h3 class="footer-logo">BetonDekor</h3>
            <p class="footer-description">Revestimentos 3D e Artefatos em cimento</p>
            <p class="footer-company-info">
                Empresa especializada em Revestimentos 3D em concreto arquitetonico e toda linha em Elemento vazado, Cobogó, Pingadeira, concregrama, Lajota, Pisante.
            </p>
            <div class="footer-social">
                <a href="#"><img src="{% static 'images/Instagram.png' %}" alt="Instagram" class="social-icon"></a>
                <a href="#"><img src="{% static 'images/Facebook.png' %}" alt="Facebook" class="social-icon"></a>
                <a href="#"><img src="{% static 'images/Email.png' %}" alt="Email" class="social-icon"></a>
            </div>
        </div>
        <div class="footer-right">
            <h4 class="footer-section-title">Empresa</h4>
            <ul class="footer-links">
                <li><a href="{% url 'quem-somos' %}" hx-get="{% url 'quem-somos' %}" hx-target="body" hx-swap="outerHTML" hx-push-url="true">Quem Somos</a></li>
                <li><a href="{% url 'produtos' %}#todos-os-produtos" hx-get="{% url 'produtos' %}" hx-target="body" hx-swap="outerHTML" hx-push-url="{% url 'produtos' %}#todos-os-produtos">Produtos</a></li>
                <li><a href="#" onclick="openContactModal(); return false;">Entre em contato</a></li>
            </ul>
            <div class="footer-contact-info">
                <p class="footer-contact-text">CNPJ: 52.342.769/0001-91</p>
                <p class="footer-contact-text">Rua Madre Peulina, 920, Lj 21 - Passa Vinte, Palhoça - SC, 88130-050</p>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p class="footer-copyright">©2025 BetonDekor. Todos os direitos reservados.</p>
    </div>
</footer>

<script>
    // Scroll para o topo da seção do produto imediatamente (sem delay).
    // Antes: havia um pequeno timeout que permitia que a página exibisse
    // parcialmente a seção "Outros Produtos" antes de rolar — por isso
    // usamos um comportamento instantâneo para posicionar corretamente.
    function scrollToProductSection(immediate = true) {
        const productSection = document.getElementById('product-detail-section');
        if (productSection) {
            const headerHeight = document.querySelector('.header')?.offsetHeight || 80;
            const sectionPosition = productSection.getBoundingClientRect().top + window.pageYOffset - headerHeight;
            
            window.scrollTo({
                top: sectionPosition,
                behavior: immediate ? 'auto' : 'smooth'
            });
        }
    }

    // Inicialização principal quando o DOM estiver pronto
    function initProductPage() {
        // Posicionar imediatamente no produto
        scrollToProductSection(true);

        // Inicializa carousel simples para as imagens do produto
        function initProductCarousel() {
            const slides = Array.from(document.querySelectorAll('.product-image-slide'));
            const leftBtn = document.querySelector('.carousel-arrow-left');
            const rightBtn = document.querySelector('.carousel-arrow-right');
            let currentIndex = 0;

            if (!slides.length) {
                if (leftBtn) leftBtn.style.display = 'none';
                if (rightBtn) rightBtn.style.display = 'none';
                return;
            }

            function showIndex(i) {
                currentIndex = (i + slides.length) % slides.length;
                slides.forEach((s, idx) => {
                    s.style.display = idx === currentIndex ? 'block' : 'none';
                });
            }

            // Inicializar estado
            showIndex(0);

            if (slides.length <= 1) {
                if (leftBtn) leftBtn.style.display = 'none';
                if (rightBtn) rightBtn.style.display = 'none';
            } else {
                if (leftBtn) {
                    leftBtn.style.display = 'flex';
                    leftBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        showIndex(currentIndex - 1);
                    });
                }
                if (rightBtn) {
                    rightBtn.style.display = 'flex';
                    rightBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        showIndex(currentIndex + 1);
                    });
                }
            }

            // Re-posicionar a página quando imagens terminarem de carregar (evita layout shift)
            let loadedAny = false;
            slides.forEach((img) => {
                if (img.complete) {
                    loadedAny = true;
                } else {
                    img.addEventListener('load', () => {
                        // quando qualquer imagem carregar, refazer o jump
                        scrollToProductSection(true);
                    });
                }
            });
            // Fallbacks para garantir posicionamento
            if (!loadedAny) {
                setTimeout(() => scrollToProductSection(true), 500);
            } else {
                // se já carregou, garantir posição imediata
                scrollToProductSection(true);
            }
        }

        initProductCarousel();
    }

    document.addEventListener('DOMContentLoaded', initProductPage);

    // Re-inicializar após swaps do HTMX
    if (typeof htmx !== 'undefined') {
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target === document.body) {
                initProductPage();
            }
        });
    }
</script>
{% endblock %}
