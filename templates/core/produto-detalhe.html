{% extends 'base.html' %}
{% load static %}

{% block title %}{{ produto.nome }} - BetonDekor{% endblock %}


{% block content %}
<!-- Header -->
{% include 'core/_header.html' %}

<!-- Main Product Display Section -->
<main id="product-detail-section" class="product-detail-main">
    <!-- Back Button -->
    <div class="back-button-container">
        <a href="{% url 'produtos' %}"
           hx-get="{% url 'produtos' %}"
           hx-target="body"
           hx-swap="outerHTML"
           hx-push-url="true"
           class="back-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Voltar para Produtos
        </a>
    </div>

    <div class="product-detail-container">
        <!-- Product Image Area: support up to 3 images as a simple carousel -->
        <div id="product-image-section" class="product-image-area">
            <style>
                /* Lightbox styles */
                .image-lightbox { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); z-index: 2000; padding: 24px; }
                .image-lightbox.active { display: flex; }
                .image-lightbox .lightbox-img-wrap { max-width: 1100px; max-height: 90vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }
                .image-lightbox img.lightbox-img { max-width: 100%; max-height: 100%; transition: transform 200ms ease; cursor: zoom-in; will-change: transform; touch-action: none; }
                .image-lightbox .lightbox-close { position: absolute; top: 18px; right: 18px; color: #fff; background: transparent; border: none; font-size: 20px; cursor: pointer; }
                #product-image-section .product-image-slide { cursor: zoom-in; }
            </style>
            {% with imagens=produto.get_imagens_urls %}
                {% if imagens %}
                    <div class="product-image-carousel">
                        {% for url in imagens %}
                            <img src="{{ url }}" alt="{{ produto.nome }} - {{ forloop.counter }}" class="product-modern-image product-image-slide" data-index="{{ forloop.counter0 }}">
                        {% endfor %}
                    </div>
                {% else %}
                    <div style="color: #999; font-family: 'Montserrat'; font-size: 18px;">Sem imagem</div>
                {% endif %}
            {% endwith %}

            <!-- Carousel arrows -->
            <button class="carousel-arrow carousel-arrow-left" aria-label="Anterior">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="carousel-arrow carousel-arrow-right" aria-label="Próximo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>

        <!-- Product Information -->
        <div class="product-info-area">
            <p class="product-category-tag">
                {% if produto.categoria %}({{ produto.categoria }}){% endif %}
            </p>
            
            <h1 class="product-detail-title">
                {{ produto.nome }}
            </h1>

            {% if produto.dimensoes %}
            <p class="product-dimensions">
                <strong>Dimensões:</strong> {{ produto.dimensoes }}
            </p>
            {% endif %}

            <div class="product-specifications">
                <ul>
                    {% if produto.categoria %}
                    <li>
                        <strong>Categoria:</strong> {{ produto.categoria }}
                    </li>
                    {% endif %}
                    {% if produto.categoria_principal %}
                    <li>
                        <strong>Categoria Principal:</strong> {{ produto.categoria_principal }}
                    </li>
                    {% endif %}
                    {% if produto.cor %}
                    <li>
                        <strong>Cor:</strong> {{ produto.cor }}
                    </li>
                    {% endif %}
                    {% if produto.unidade_venda %}
                    <li>
                        <strong>Unidade de Venda:</strong> {{ produto.unidade_venda }}
                    </li>
                    {% endif %}
                    {% if produto.especificacoes %}
                    <li>
                        <strong>Especificação:</strong> {{ produto.especificacoes }}
                    </li>
                    {% endif %}
                </ul>
            </div>

            <a href="#" class="contact-button-main" onclick="openContactModal(); return false;">
                Entre em Contato
            </a>
        </div>
    </div>
</main>

<!-- Lightbox for product detail images -->
<div id="detail-image-lightbox" class="image-lightbox" aria-hidden="true">
    <button class="lightbox-close" id="detail-lightbox-close" aria-label="Fechar">✕</button>
    <div class="lightbox-img-wrap">
        <img src="" alt="" id="detail-lightbox-img" class="lightbox-img">
    </div>
</div>

<!-- Other Products Section -->
<style>
    /* Cards "Outros Produtos" — mesmo padrão visual da página /produtos */
    .other-products-grid .product-card-modern {
        position: relative;
        width: 100%;
        padding: 0;
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        display: flex;
        align-items: stretch;
        justify-content: center;
        aspect-ratio: 4 / 5;
        max-height: 420px;
        border: none;
    }
    .other-products-grid .product-modern-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    .other-products-grid .product-card-modern .pill-button {
        position: absolute;
        bottom: 18px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 5;
        background: rgba(0,0,0,0.35);
        border: none;
        color: #fff !important;
        text-transform: uppercase;
        font-size: 13px;
        letter-spacing: 1px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        white-space: nowrap;
        text-decoration: none;
        width: auto;
        max-width: none;
        box-shadow: none;
        cursor: pointer;
        text-shadow: 0 1px 2px rgba(0,0,0,0.6);
        border-radius: 8px;
        backdrop-filter: blur(2px);
        margin: 0;
    }
    .other-products-grid .product-card-modern .pill-button::after {
        content: '\2192';
        display: inline-block;
        font-size: 16px;
        line-height: 1;
        margin-left: 6px;
        transform: translateY(1px);
    }
    .other-products-grid .product-card-modern .pill-button:hover { opacity: 0.95; }
    .other-products-grid .product-tag,
    .other-products-grid .product-meta,
    .other-products-grid .product-modern-name { display: none !important; }
</style>
<section class="other-products-section">
    <h2 class="other-products-title">
        <span>OUTROS</span> <strong>PRODUTOS</strong>
    </h2>
    
    <div class="other-products-grid">
        {% for outro_produto in outros_produtos %}
        <a href="{% url 'produto-detalhe' outro_produto.slug %}" 
           hx-get="{% url 'produto-detalhe' outro_produto.slug %}"
           hx-target="body"
           hx-swap="outerHTML"
           hx-push-url="true"
           class="product-card-wrapper product-card-link"
           style="text-decoration: none; color: inherit;">
            <div class="product-card-modern">
                {% if outro_produto.get_imagem_url %}
                    <img src="{{ outro_produto.get_imagem_url }}" alt="{{ outro_produto.nome }}" class="product-modern-image">
                {% else %}
                    <div class="product-modern-image" style="background: #f0f0f0; height: 150px; display: flex; align-items: center; justify-content: center; color: #999;">Sem imagem</div>
                {% endif %}
                <button class="pill-button">Ver detalhes</button>
            </div>
        </a>
        {% empty %}
        <p style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999; font-family: 'Montserrat';">Nenhum outro produto disponível.</p>
        {% endfor %}
    </div>
</section>

<!-- Footer -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-left">
            <h3 class="footer-logo">BetonDekor</h3>
            <p class="footer-description">Revestimentos 3D e Artefatos em cimento</p>
            <p class="footer-company-info">
                Empresa especializada em Revestimentos 3D em concreto arquitetonico e toda linha em Elemento vazado, Cobogó, Pingadeira, concregrama, Lajota, Pisante.
            </p>
            <div class="footer-social">
                <a href="#"><img src="{% static 'images/Instagram.png' %}" alt="Instagram" class="social-icon"></a>
                <a href="#"><img src="{% static 'images/Facebook.png' %}" alt="Facebook" class="social-icon"></a>
                <a href="#"><img src="{% static 'images/Email.png' %}" alt="Email" class="social-icon"></a>
            </div>
        </div>
        <div class="footer-right">
            <h4 class="footer-section-title">Empresa</h4>
            <ul class="footer-links">
                <li><a href="{% url 'quem-somos' %}" hx-get="{% url 'quem-somos' %}" hx-target="body" hx-swap="outerHTML" hx-push-url="true">Quem Somos</a></li>
                <li><a href="{% url 'produtos' %}#todos-os-produtos" hx-get="{% url 'produtos' %}" hx-target="body" hx-swap="outerHTML" hx-push-url="{% url 'produtos' %}#todos-os-produtos">Produtos</a></li>
                <li><a href="#" onclick="openContactModal(); return false;">Entre em contato</a></li>
            </ul>
            <div class="footer-contact-info">
                <p class="footer-contact-text">CNPJ: 52.342.769/0001-91</p>
                <p class="footer-contact-text">Rua Madre Peulina, 920, Lj 21 - Passa Vinte, Palhoça - SC, 88130-050</p>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p class="footer-copyright">©2025 BetonDekor. Todos os direitos reservados.</p>
    </div>
</footer>

<script>
    // Scroll para o topo da seção do produto imediatamente (sem delay).
    // Antes: havia um pequeno timeout que permitia que a página exibisse
    // parcialmente a seção "Outros Produtos" antes de rolar — por isso
    // usamos um comportamento instantâneo para posicionar corretamente.
    function scrollToProductSection(immediate = true) {
        const productSection = document.getElementById('product-detail-section');
        if (productSection) {
            const headerHeight = document.querySelector('.header')?.offsetHeight || 80;
            const sectionPosition = productSection.getBoundingClientRect().top + window.pageYOffset - headerHeight;
            
            window.scrollTo({
                top: sectionPosition,
                behavior: immediate ? 'auto' : 'smooth'
            });
        }
    }

    // Inicialização principal quando o DOM estiver pronto
    function initProductPage() {
        // Posicionar imediatamente no produto
        scrollToProductSection(true);

        // Inicializa carousel simples para as imagens do produto
        function initProductCarousel() {
            const slides = Array.from(document.querySelectorAll('.product-image-slide'));
            const leftBtn = document.querySelector('.carousel-arrow-left');
            const rightBtn = document.querySelector('.carousel-arrow-right');
            let currentIndex = 0;

            if (!slides.length) {
                if (leftBtn) leftBtn.style.display = 'none';
                if (rightBtn) rightBtn.style.display = 'none';
                return;
            }

            function showIndex(i) {
                currentIndex = (i + slides.length) % slides.length;
                slides.forEach((s, idx) => {
                    s.style.display = idx === currentIndex ? 'block' : 'none';
                });
            }

            // Inicializar estado
            showIndex(0);

            if (slides.length <= 1) {
                if (leftBtn) leftBtn.style.display = 'none';
                if (rightBtn) rightBtn.style.display = 'none';
            } else {
                if (leftBtn) {
                    leftBtn.style.display = 'flex';
                    leftBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        showIndex(currentIndex - 1);
                    });
                }
                if (rightBtn) {
                    rightBtn.style.display = 'flex';
                    rightBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        showIndex(currentIndex + 1);
                    });
                }
            }

            // Re-posicionar a página quando imagens terminarem de carregar (evita layout shift)
            let loadedAny = false;
            slides.forEach((img) => {
                if (img.complete) {
                    loadedAny = true;
                } else {
                    img.addEventListener('load', () => {
                        // quando qualquer imagem carregar, refazer o jump
                        scrollToProductSection(true);
                    });
                }
            });
            // Fallbacks para garantir posicionamento
            if (!loadedAny) {
                setTimeout(() => scrollToProductSection(true), 500);
            } else {
                // se já carregou, garantir posição imediata
                scrollToProductSection(true);
            }
        }

        initProductCarousel();
    }

    // Initialize immediately (script runs after DOM above it)
    initProductPage();

    /* Lightbox and image interactions for product detail page (pan/zoom) */
    (function(){
        let scale = 1, tx = 0, ty = 0;
        let isPanning = false, startX = 0, startY = 0, activePointer = null;

        function getLB() { return document.getElementById('detail-image-lightbox'); }
        function getLBImg() { return document.getElementById('detail-lightbox-img'); }

        function apply(){
            const lbImg = getLBImg();
            if (!lbImg) return;
            lbImg.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
            lbImg.style.cursor = scale > 1 ? 'grab' : 'zoom-in';
        }

        function openLB(src, alt){
            const lb = getLB(); const lbImg = getLBImg();
            if (!lb || !lbImg) return;
            lbImg.src = src; lbImg.alt = alt || '';
            lb.classList.add('active'); lb.setAttribute('aria-hidden','false');
            document.body.style.overflow = 'hidden';
            scale = 1; tx = 0; ty = 0; apply();
            lbImg.style.touchAction = 'none';
        }

        function closeLB(){
            const lb = getLB(); const lbImg = getLBImg();
            if (!lb) return;
            lb.classList.remove('active'); lb.setAttribute('aria-hidden','true');
            if (lbImg) { lbImg.src = ''; lbImg.style.touchAction = ''; }
            document.body.style.overflow = '';
            scale = 1; tx = 0; ty = 0; apply();
        }

        // Global escape key (only needs to bind once)
        document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeLB(); });

        function initDetailLightbox() {
            const lb = getLB(); const lbImg = getLBImg();
            const lbClose = document.getElementById('detail-lightbox-close');

            if (lbClose) lbClose.onclick = closeLB;
            if (lb) lb.onclick = function(e){ if (e.target === lb) closeLB(); };

            // Attach click on all images in the image section
            const slides = document.querySelectorAll('#product-image-section img, #product-image-section .product-image-slide, #product-image-section .product-modern-image');
            slides.forEach(function(elem) {
                elem.style.cursor = 'zoom-in';
                elem.onclick = function(e){
                    e.preventDefault();
                    e.stopPropagation();
                    if (elem.tagName === 'IMG') {
                        openLB(elem.src, elem.alt || '');
                    }
                };
            });

            if (!lbImg) return;
            // Pan/zoom interactions — use onclick/on* to avoid duplicate listeners on re-init
            lbImg.onpointerdown = function(e){ if (scale <= 1) return; isPanning = true; startX = e.clientX - tx; startY = e.clientY - ty; activePointer = e.pointerId; lbImg.setPointerCapture(activePointer); lbImg.style.cursor = 'grabbing'; };
            lbImg.onpointermove = function(e){ if (!isPanning || e.pointerId !== activePointer) return; tx = e.clientX - startX; ty = e.clientY - startY; apply(); };
            lbImg.onpointerup = lbImg.onpointercancel = lbImg.onpointerleave = function(e){ if (e.pointerId !== activePointer) return; isPanning = false; try{ lbImg.releasePointerCapture(activePointer); }catch(_){} activePointer = null; lbImg.style.cursor = scale > 1 ? 'grab' : 'zoom-in'; };

            // Wheel zoom
            lb.onwheel = function(e){ e.preventDefault(); const d = e.deltaY > 0 ? -0.1 : 0.1; scale = Math.max(1, Math.min(3, scale + d)); if (scale === 1){ tx = 0; ty = 0; } apply(); };

            // Double-click toggle zoom
            lbImg.ondblclick = function(){ if (scale > 1){ scale = 1; tx = 0; ty = 0; } else { scale = 2; } apply(); };
        }

        // Initialize immediately
        initDetailLightbox();
    })();
</script>
{% endblock %}
