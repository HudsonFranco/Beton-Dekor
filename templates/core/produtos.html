{% extends 'base.html' %}
{% load static %}

{% block title %}Produtos - BetonDekor{% endblock %}

                        <a href="#" class="filter-subcategory-link" data-subcategoria="{{ sub.nome|lower }}" data-categoria-principal="{{ item.categoria.nome|lower }}">{{ sub.nome }}</a>
        color: #666 !important;
        text-decoration: none;
    }
    .filter-group ul li a.filter-product-link:hover,
    .mobile-filter-content .mobile-filter-item a.mobile-filter-product-link:hover,
                    {% for sub in item.categoria.subcategorias.all %}
                    {% if sub.ativo %}
                    <li class="filter-item">
                        <a href="#" class="filter-subcategory-link" data-subcategoria="{{ sub.nome|lower }}" data-categoria-principal="{{ item.categoria.nome|lower }}">{{ sub.nome }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
    .mobile-filter-content .mobile-filter-group ul li a:hover {
        color: #444 !important;
        text-decoration: none;
    }

    .products-hero-section {
        background-image: url('{% static "images/ConhecaProdutos.jpg" %}') !important;
        background-size: cover !important;
        /* mover um pouco o foco da imagem para cima */
        background-position: center top !important;
        background-repeat: no-repeat !important;
        position: relative;
        /* diminuir um pouco a altura para que o bg fique mais para cima */
        min-height: 520px;
        display: flex;
        flex-direction: column;
    }
    
    .products-hero-section.hero-section {
        background-image: url('{% static "images/ConhecaProdutos.jpg" %}') !important;
    }
    
    /* Garantir que a imagem de produtos sempre sobrescreva a de home */
    section.hero-section.products-hero-section {
        background-image: url('{% static "images/ConhecaProdutos.jpg" %}') !important;
    }
    /* Ajustes móveis: reduzir ainda mais a altura em telas pequenas */
    @media (max-width: 768px) {
        .products-hero-section {
            min-height: 420px;
            background-position: center top !important;
        }
    }
    @media (max-width: 480px) {
        .products-hero-section {
            min-height: 360px;
            background-position: center top !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section products-hero-section">
    <div class="hero-overlay"></div>
    <div class="hero-gradient"></div>
    
    {% include 'core/_header.html' %}
    
    <!-- Hero Content -->
    <div class="hero-content">
        <h1 class="hero-title">
            <div class="hero-title-line-1">
                <span class="hero-title-light">Conheça nossos</span>
            </div>
            <div class="hero-title-line-2">
                <span class="hero-title-bold">Produtos</span>
            </div>
        </h1>
    </div>
</section>

<!-- Mobile Filter Menu -->
<div class="mobile-filter-overlay" id="mobile-filter-overlay"></div>
<div class="mobile-filter-menu" id="mobile-filter-menu">
    <div class="mobile-filter-header">
        <h3>Filtros</h3>
        <button class="mobile-filter-close" id="mobile-filter-close" aria-label="Fechar filtros">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="#262626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
    <div class="mobile-filter-content">
        <div class="mobile-filter-search">
            <input type="text" id="mobile-product-search" placeholder="Procurar produto..." autocomplete="off">
        </div>

        <div class="mobile-filter-group">
            <button type="button" class="mobile-filter-all-products">
                Todos os Produtos
            </button>
        </div>

        {% for item in produtos_agrupados_list %}
        <div class="mobile-filter-group">
            <h3 class="mobile-filter-category-title" data-categoria-principal="{{ item.categoria.nome|lower }}">{{ item.categoria.nome }}</h3>
            <ul>
                {% for sub in item.categoria.subcategorias.all %}
                <li class="mobile-filter-item">
                    <a href="#" class="mobile-filter-subcategory-link" data-subcategoria="{{ sub.nome|lower }}" data-categoria-principal="{{ item.categoria.nome|lower }}">{{ sub.nome }}</a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Main Content -->
<main class="products-page" id="products-section">
    <!-- Desktop Title -->
    <div class="products-header-desktop">
        <h2 class="products-page-title" id="todos-os-produtos"><span>Todos os</span> <strong>Produtos</strong></h2>
    </div>

    <div class="products-header-mobile">
        <h2 class="products-page-title" id="todos-os-produtos-mobile"><span>Todos os</span> <strong>Produtos</strong></h2>
        <button class="mobile-filter-toggle" id="mobile-filter-btn" aria-label="Abrir filtros">
            Categorias
        </button>
    </div>

    <div class="products-layout">
        <aside class="products-filter">
            <div class="filter-search">
                <input type="text" id="product-search" placeholder="Procurar produto..." autocomplete="off">
            </div>

            <div class="filter-group">
                <button type="button" class="filter-all-products">
                    Todos os Produtos
                </button>
            </div>

            {% for item in produtos_agrupados_list %}
            <div class="filter-group">
                <h3 class="filter-category-title" data-categoria-principal="{{ item.categoria.nome|lower }}" style="cursor: pointer;">{{ item.categoria.nome }}</h3>
                <ul>
                    {% for sub in item.categoria.subcategorias.all %}
                    <li class="filter-item">
                        <a href="#" class="filter-subcategory-link" data-subcategoria="{{ sub.nome|lower }}" data-categoria-principal="{{ item.categoria.nome|lower }}">{{ sub.nome }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </aside>

        <div class="products-wrapper" id="products-cards-section">
            <div class="products-cards-container">
                <div class="products-cards">
                    {% for produto in produtos %}
                    {% if produto.slug %}
                    <a href="{% url 'produto-detalhe' produto.slug %}" 
                       hx-get="{% url 'produto-detalhe' produto.slug %}"
                       hx-target="body"
                       hx-swap="outerHTML"
                       hx-push-url="true"
                       class="product-card-wrapper product-card-link"
                       data-product-name="{{ produto.nome|lower }}"
                       data-product-category="{{ produto.categoria|lower }}"
                       data-product-subcategoria="{{ produto.subcategoria_nome|lower }}"
                       data-categoria-principal="{{ produto.categoria_principal|lower }}">
                        <div class="product-card-modern">
                            <p class="product-tag">{{ produto.tag }}</p>
                            {% if produto.imagem %}
                                <img src="{{ produto.imagem.url }}" alt="{{ produto.nome }}" class="product-modern-image">
                            {% elif produto.imagem_nome %}
                                <img src="{% static 'images/'|add:produto.imagem_nome %}" alt="{{ produto.nome }}" class="product-modern-image">
                            {% else %}
                                <div class="product-modern-image" style="background: #f0f0f0; height: 150px; display: flex; align-items: center; justify-content: center; color: #999;">Sem imagem</div>
                            {% endif %}
                            <h3 class="product-modern-name">{{ produto.nome }}</h3>
                            <p class="product-meta">
                                {% if produto.categoria_principal %}{{ produto.categoria_principal }}{% endif %}
                                {% if produto.categoria %}({{ produto.categoria }}){% endif %}
                            </p>
                            <button class="pill-button">Ver detalhes</button>
                        </div>
                    </a>
                    {% endif %}
                    {% empty %}
                    <p style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">Nenhum produto cadastrado ainda.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/products-page.js' %}"></script>
<script>
// Configuração de debug (opcional - remover em produção)
window.DEBUG = true;

function initMobileFilterMenu() {
    const mobileFilterBtn = document.getElementById('mobile-filter-btn');
    const mobileFilterMenu = document.getElementById('mobile-filter-menu');
    const mobileFilterOverlay = document.getElementById('mobile-filter-overlay');
    const mobileFilterClose = document.getElementById('mobile-filter-close');
    const mobileProductSearch = document.getElementById('mobile-product-search');
    const mobileFilterAllProducts = document.querySelector('.mobile-filter-all-products');

    // Open mobile filter menu
    if (mobileFilterBtn) {
        mobileFilterBtn.addEventListener('click', function() {
            mobileFilterMenu.classList.add('active');
            mobileFilterOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        });
    }

    // Close mobile filter menu
    function closeMobileFilter() {
        mobileFilterMenu.classList.remove('active');
        mobileFilterOverlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }

    if (mobileFilterClose) {
        mobileFilterClose.addEventListener('click', closeMobileFilter);
    }

    if (mobileFilterOverlay) {
        mobileFilterOverlay.addEventListener('click', closeMobileFilter);
    }

    // Mobile search functionality
    if (mobileProductSearch) {
        mobileProductSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const productCards = document.querySelectorAll('.product-card-modern');
            const productNames = document.querySelectorAll('.product-modern-name');

            productCards.forEach((card, index) => {
                const productName = productNames[index].textContent.toLowerCase();
                if (productName.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }

    // Mobile "All Products" button
    if (mobileFilterAllProducts) {
        mobileFilterAllProducts.addEventListener('click', function() {
            // Clear search
            if (mobileProductSearch) {
                mobileProductSearch.value = '';
            }

            // Show all products
            const productCards = document.querySelectorAll('.product-card-modern');
            productCards.forEach(card => {
                card.style.display = 'block';
            });

            // Close menu
            closeMobileFilter();
        });
    }

    // Mobile category filtering
    const mobileCategoryTitles = document.querySelectorAll('.mobile-filter-category-title');
    mobileCategoryTitles.forEach(title => {
        title.addEventListener('click', function() {
            const categoriaPrincipal = this.getAttribute('data-categoria-principal');
            console.log('Filtering by categoria:', categoriaPrincipal);
            const productCards = document.querySelectorAll('.product-card-link');
            let visibleCount = 0;

            productCards.forEach(card => {
                const cardCategoriaPrincipal = card.getAttribute('data-categoria-principal');
                console.log('Card categoria:', cardCategoriaPrincipal);
                if (cardCategoriaPrincipal === categoriaPrincipal) {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            console.log('Visible products:', visibleCount);

            // Close menu
            closeMobileFilter();
        });
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initMobileFilterMenu);

// Initialize immediately
initMobileFilterMenu();

// Re-initialize after HTMX swaps
if (typeof htmx !== 'undefined') {
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target === document.body) {
            initMobileFilterMenu();
        }
    });
}
    document.addEventListener('DOMContentLoaded', function() {
        // Filtrar produtos por subcategoria
        const productCards = document.querySelectorAll('.products-cards .product-card-wrapper');

        function showAllProducts() {
            productCards.forEach(card => card.style.display = '');
        }

        function filterBySubcategory(sub) {
            if (!sub) {
                showAllProducts();
                return;
            }
            productCards.forEach(card => {
                const cardSub = (card.dataset.productSubcategoria || card.dataset.productCategory || '').toLowerCase();
                if (cardSub === sub.toLowerCase()) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
            // Scroll to top of products list
            const container = document.getElementById('products-cards-section');
            if (container) container.scrollIntoView({behavior: 'smooth'});
        }

        // Desktop subcategory links
        document.querySelectorAll('.filter-subcategory-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sub = this.dataset.subcategoria;
                filterBySubcategory(sub);
            });
        });

        // Mobile subcategory links
        document.querySelectorAll('.mobile-filter-subcategory-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sub = this.dataset.subcategoria;
                // close mobile menu
                const mobileMenu = document.getElementById('mobile-filter-menu');
                const mobileOverlay = document.getElementById('mobile-filter-overlay');
                if (mobileMenu) mobileMenu.classList.remove('active');
                if (mobileOverlay) mobileOverlay.classList.remove('active');
                document.body.style.overflow = '';
                filterBySubcategory(sub);
            });
        });
    });
</script>
{% endblock %}
