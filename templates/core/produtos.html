{% extends 'base.html' %}
{% load static %}

{% block title %}Produtos - BetonDekor{% endblock %}

{% block extra_css %}
<style>
    /* Subcategoria / filtros: usar cinza mais claro */
    .filter-group ul li a.filter-product-link,
    .mobile-filter-content .mobile-filter-item a.mobile-filter-product-link,
    .mobile-filter-content .mobile-filter-group ul li a,
    .filter-subcategory-link,
    .mobile-filter-subcategory-link {
        color: #888 !important;
        text-decoration: none;
    }
    .filter-group ul li a.filter-product-link:hover,
    .mobile-filter-content .mobile-filter-item a.mobile-filter-product-link:hover,
    .mobile-filter-content .mobile-filter-group ul li a:hover,
    .filter-subcategory-link:hover,
    .mobile-filter-subcategory-link:hover {
        color: #666 !important;
        text-decoration: none;
    }

    .products-hero-section {
        background-image: url('{% static "images/ConhecaProdutos.jpg" %}') !important;
        background-size: cover !important;
        /* mover um pouco o foco da imagem para cima */
        background-position: center top !important;
        background-repeat: no-repeat !important;
        position: relative;
        /* diminuir um pouco a altura para que o bg fique mais para cima */
        min-height: 520px;
        display: flex;
        flex-direction: column;
    }
    
    .products-hero-section.hero-section {
        background-image: url('{% static "images/ConhecaProdutos.jpg" %}') !important;
    }
    
    /* Garantir que a imagem de produtos sempre sobrescreva a de home */
    section.hero-section.products-hero-section {
        background-image: url('{% static "images/ConhecaProdutos.jpg" %}') !important;
    }
    /* Ajustes móveis: reduzir ainda mais a altura em telas pequenas */
    @media (max-width: 768px) {
        .products-hero-section {
            min-height: 420px;
            background-position: center top !important;
        }
    }
    @media (max-width: 480px) {
        .products-hero-section {
            min-height: 360px;
            background-position: center top !important;
        }
    }

    /* Cards: imagem preenche todo o card; botão sobreposto */
    .product-card-wrapper {
        display: block;
        width: 100%;
    }
    /* garantir que o link que envolve o card ocupe todo o espaço do card */
    .product-card-link {
        display: block;
        height: 100%;
        text-decoration: none;
        color: inherit;
    }
    .product-card-modern {
        position: relative;
        width: 100%;
        padding: 0;
        border-radius: 12px;
        overflow: hidden; /* container recorta imagem, evitando vazios cinza */
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        display: flex;
        align-items: stretch;
        justify-content: center;
        aspect-ratio: 4 / 5; /* mantém proporção consistente */
        max-height: 420px;
    }
    .product-modern-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* responsive tweaks for cards */
    @media (max-width: 1024px) {
        .product-card-modern { aspect-ratio: 4 / 5; max-height: 400px; }
    }
    @media (max-width: 768px) {
        .product-card-modern { aspect-ratio: 3 / 4; max-height: 360px; }
    }
    @media (max-width: 480px) {
        .product-card-modern { aspect-ratio: 1 / 1; max-height: 360px; }
    }

    /* Lightbox / modal de imagem */
    .image-lightbox {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.85);
        z-index: 2000;
        padding: 24px;
    }
    .image-lightbox.active {
        display: flex;
    }
    .image-lightbox .lightbox-img-wrap {
        max-width: 1100px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .image-lightbox img.lightbox-img {
        max-width: 100%;
        max-height: 100%;
        transition: transform 200ms ease;
        cursor: zoom-in;
        will-change: transform;
    }
    .image-lightbox .lightbox-close {
        position: absolute;
        top: 18px;
        right: 18px;
        color: #fff;
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }
    /* esconder textos que não devem aparecer (exceção: o nome do produto ficará visível como overlay) */
    .product-tag,
    .product-meta {
        display: none !important;
    }

    /* overlay: gradiente leve para melhorar contraste do título sobre a imagem */
    .product-card-modern::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.6) 10%, rgba(0,0,0,0.25) 30%, rgba(0,0,0,0.05) 60%, rgba(0,0,0,0) 100%);
        z-index: 4;
        pointer-events: none;
    }

    /* Nome do produto posicionado mais embaixo, próximo ao botão "Ver detalhes".
       Use a classe global `product-name` (mesma usada na home) for typography, keeping
       only positioning/overlay-specific rules here so the lettering matches the home cards. */
    .product-card-modern .product-modern-name {
        position: absolute;
        bottom: 64px; /* acima do botão (btn bottom:18px), ajuste se necessário */
        left: 20px;
        right: 20px;
        margin: 0;
        z-index: 6;
        color: #fff;
        /* typography comes from global `.product-name` (font-family, size, weight, transform) */
        text-shadow: 0 4px 18px rgba(0,0,0,0.65);
        display: block !important;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
        max-height: 2.6em; /* até 2 linhas */
    }

    @media (max-width: 1024px) {
        .product-card-modern .product-modern-name { bottom: 64px; }
    }
    @media (max-width: 768px) {
        .product-card-modern .product-modern-name { bottom: 60px; left: 14px; right: 14px; }
    }
    /* botão sobreposto na parte inferior, estilo similar à referência
       - branco, maiúsculas, seta à direita, posicionado canto inferior esquerdo */
    .product-card-modern .pill-button {
        position: absolute;
        bottom: 18px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 5;
        background: rgba(0,0,0,0.35);
        border: none;
        color: #fff !important;
        text-transform: uppercase;
        font-size: 13px;
        letter-spacing: 1px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        white-space: nowrap;
        text-decoration: none;
        width: auto;
        max-width: none;
        box-shadow: none;
        cursor: pointer;
        text-shadow: 0 1px 2px rgba(0,0,0,0.6);
        border-radius: 8px;
        backdrop-filter: blur(2px);
    }

    /* seta à direita como pseudo-elemento */
    .product-card-modern .pill-button::after {
        content: '\2192'; /* → */
        display: inline-block;
        font-size: 16px;
        line-height: 1;
        margin-left: 6px;
        transform: translateY(1px);
    }

    /* hover: leve clareamento para indicar interatividade */
    .product-card-modern .pill-button:hover {
        opacity: 0.95;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section products-hero-section">
    <div class="hero-overlay"></div>
    <div class="hero-gradient"></div>
    
    {% include 'core/_header.html' %}
    
    <!-- Hero Content -->
    <div class="hero-content">
        <h1 class="hero-title">
            <div class="hero-title-line-1">
                <span class="hero-title-light">Conheça nossos</span>
            </div>
            <div class="hero-title-line-2">
                <span class="hero-title-bold">Produtos</span>
            </div>
        </h1>
    </div>
</section>

<!-- Inline critical styles for products page (included in body so HTMX swaps apply them) -->
<style id="products-inline-styles">
    .product-card-wrapper { display: block; width: 100%; text-decoration: none; color: inherit; }
    .product-card-link { display: block; height: 100%; text-decoration: none; color: inherit; }
    .product-card-modern { position: relative; width: 100%; padding: 0; border-radius: 12px; overflow: hidden; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; align-items: stretch; justify-content: center; aspect-ratio: 4 / 5; max-height: 420px; border: none; }
    .product-modern-image { width: 100%; height: 100%; object-fit: cover; display: block; }
    .product-tag, .product-meta { display: none !important; }
    .product-card-modern::before { content: ''; position: absolute; inset: 0; background: linear-gradient(180deg, rgba(0,0,0,0.6) 10%, rgba(0,0,0,0.25) 30%, rgba(0,0,0,0.05) 60%, rgba(0,0,0,0) 100%); z-index: 4; pointer-events: none; }
    .product-card-modern .pill-button { position: absolute; bottom: 18px; left: 50%; transform: translateX(-50%); z-index: 5; white-space: nowrap; background: rgba(0,0,0,0.35); border: none; color: #fff !important; text-transform: uppercase; font-size: 13px; letter-spacing: 1px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; text-decoration: none; width: auto; max-width: none; margin: 0; box-shadow: none; cursor: pointer; text-shadow: 0 1px 2px rgba(0,0,0,0.6); border-radius: 8px; backdrop-filter: blur(2px); }
    .product-card-modern .pill-button::after { content: '\2192'; display: inline-block; font-size: 16px; line-height: 1; margin-left: 6px; transform: translateY(1px); }
    .product-card-modern .pill-button:hover { opacity: 0.95; }
    /* Responsive inline (HTMX compat) */
    .products-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 22px; }
    @media (max-width: 1200px) { .products-cards { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 992px) { .products-filter { display: none; } .products-layout { grid-template-columns: 1fr; } }
    @media (max-width: 480px) { .products-cards { grid-template-columns: repeat(2, 1fr); gap: 8px; } .product-card-modern { aspect-ratio: 3/4; max-height: 280px; border-radius: 8px; } }
    @media (max-width: 360px) { .products-cards { gap: 6px; } .product-card-modern { max-height: 240px; } }
</style>
<style id="products-inline-filters">
    .filter-group ul li a.filter-product-link,
    .mobile-filter-content .mobile-filter-item a.mobile-filter-product-link,
    .mobile-filter-content .mobile-filter-group ul li a,
    .filter-subcategory-link,
    .mobile-filter-subcategory-link {
        color: #888 !important;
        text-decoration: none;
    }
    .filter-group ul li a.filter-product-link:hover,
    .mobile-filter-content .mobile-filter-item a.mobile-filter-product-link:hover,
    .mobile-filter-content .mobile-filter-group ul li a:hover,
    .filter-subcategory-link:hover,
    .mobile-filter-subcategory-link:hover {
        color: #666 !important;
        text-decoration: none;
    }
</style>

<!-- Mobile Filter Menu -->
<div class="mobile-filter-overlay" id="mobile-filter-overlay"></div>
<div class="mobile-filter-menu" id="mobile-filter-menu">
    <div class="mobile-filter-header">
        <h3>Filtros</h3>
        <button class="mobile-filter-close" id="mobile-filter-close" aria-label="Fechar filtros">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" stroke="#262626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
    <div class="mobile-filter-content">
        <div class="mobile-filter-search">
            <input type="text" id="mobile-product-search" placeholder="Procurar produto..." autocomplete="off">
        </div>

        <div class="mobile-filter-group">
            <button type="button" class="mobile-filter-all-products">
                Todos os Produtos
            </button>
        </div>

        {% for item in produtos_agrupados_list %}
        <div class="mobile-filter-group">
            <h3 class="mobile-filter-category-title" data-categoria-principal="{{ item.categoria.nome|lower }}">{{ item.categoria.nome }}</h3>
            <ul>
                {% for sub in item.categoria.subcategorias.all %}
                <li class="mobile-filter-item">
                    <a href="#" class="mobile-filter-subcategory-link" data-subcategoria="{{ sub.nome|lower }}" data-categoria-principal="{{ item.categoria.nome|lower }}">{{ sub.nome }}</a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Main Content -->
<main class="products-page" id="products-section">
    <!-- Desktop Title -->
    <div class="products-header-desktop">
        <h2 class="products-page-title" id="todos-os-produtos"><span>Todos os</span> <strong>Produtos</strong></h2>
    </div>

    <div class="products-header-mobile">
        <h2 class="products-page-title" id="todos-os-produtos-mobile"><span>Todos os</span> <strong>Produtos</strong></h2>
        <button class="mobile-filter-toggle" id="mobile-filter-btn" aria-label="Abrir filtros">
            Categorias
        </button>
    </div>

    <div class="products-layout">
        <aside class="products-filter">
            <div class="filter-search">
                <input type="text" id="product-search" placeholder="Procurar produto..." autocomplete="off">
            </div>

            <div class="filter-group">
                <button type="button" class="filter-all-products">
                    Todos os Produtos
                </button>
            </div>

            {% for item in produtos_agrupados_list %}
            <div class="filter-group">
                <h3 class="filter-category-title" data-categoria-principal="{{ item.categoria.nome|lower }}" style="cursor: pointer;">{{ item.categoria.nome }}</h3>
                <ul>
                    {% for sub in item.categoria.subcategorias.all %}
                    <li class="filter-item">
                        <a href="#" class="filter-subcategory-link" data-subcategoria="{{ sub.nome|lower }}" data-categoria-principal="{{ item.categoria.nome|lower }}">{{ sub.nome }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </aside>

        <div class="products-wrapper" id="products-cards-section">
            <div class="products-cards-container">
                <div class="products-cards">
                    {% for produto in produtos %}
                    {% if produto.slug %}
                    <a href="{% url 'produto-detalhe' produto.slug %}" 
                       hx-get="{% url 'produto-detalhe' produto.slug %}"
                       hx-target="body"
                       hx-swap="outerHTML"
                       hx-push-url="true"
                       class="product-card-wrapper product-card-link"
                       data-product-name="{{ produto.nome|lower }}"
                       data-product-category="{{ produto.categoria|lower }}"
                       data-product-subcategoria="{{ produto.subcategoria_nome|lower }}"
                       data-categoria-principal="{{ produto.categoria_principal|lower }}">
                        <div class="product-card-modern">
                            <p class="product-tag">{{ produto.tag }}</p>
                            {% if produto.imagem %}
                                <img src="{{ produto.imagem.url }}" alt="{{ produto.nome }}" class="product-modern-image">
                            {% elif produto.imagem_nome %}
                                <img src="{% static 'images/'|add:produto.imagem_nome %}" alt="{{ produto.nome }}" class="product-modern-image">
                            {% else %}
                                <div class="product-modern-image" style="background: #f0f0f0; height: 150px; display: flex; align-items: center; justify-content: center; color: #999;">Sem imagem</div>
                            {% endif %}
                            <!-- Nome removido do card; aparece apenas no detalhe -->
                            <button class="pill-button">Ver detalhes</button>
                        </div>
                    </a>
                    {% endif %}
                    {% empty %}
                    <p style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">Nenhum produto cadastrado ainda.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</main>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/products-page.js' %}"></script>
<script>
// Configuração de debug (opcional - remover em produção)
window.DEBUG = true;

function initMobileFilterMenu() {
    const mobileFilterBtn = document.getElementById('mobile-filter-btn');
    const mobileFilterMenu = document.getElementById('mobile-filter-menu');
    const mobileFilterOverlay = document.getElementById('mobile-filter-overlay');
    const mobileFilterClose = document.getElementById('mobile-filter-close');
    const mobileProductSearch = document.getElementById('mobile-product-search');
    const mobileFilterAllProducts = document.querySelector('.mobile-filter-all-products');

    // Open mobile filter menu
    if (mobileFilterBtn) {
        mobileFilterBtn.addEventListener('click', function() {
            mobileFilterMenu.classList.add('active');
            mobileFilterOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        });
    }

    // Close mobile filter menu
    function closeMobileFilter() {
        mobileFilterMenu.classList.remove('active');
        mobileFilterOverlay.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }

    if (mobileFilterClose) {
        mobileFilterClose.addEventListener('click', closeMobileFilter);
    }

    if (mobileFilterOverlay) {
        mobileFilterOverlay.addEventListener('click', closeMobileFilter);
    }

    // Mobile search functionality
    if (mobileProductSearch) {
        mobileProductSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const productCards = document.querySelectorAll('.product-card-modern');
            const productNames = document.querySelectorAll('.product-modern-name');

            productCards.forEach((card, index) => {
                const productName = productNames[index].textContent.toLowerCase();
                if (productName.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }

    // Mobile "All Products" button
    if (mobileFilterAllProducts) {
        mobileFilterAllProducts.addEventListener('click', function() {
            // Clear search
            if (mobileProductSearch) {
                mobileProductSearch.value = '';
            }

            // Show all products
            const productCards = document.querySelectorAll('.product-card-modern');
            productCards.forEach(card => {
                card.style.display = 'block';
            });

            // Close menu
            closeMobileFilter();
        });
    }

    // Mobile category filtering
    const mobileCategoryTitles = document.querySelectorAll('.mobile-filter-category-title');
    mobileCategoryTitles.forEach(title => {
        title.addEventListener('click', function() {
            const categoriaPrincipal = this.getAttribute('data-categoria-principal');
            console.log('Filtering by categoria:', categoriaPrincipal);
            const productCards = document.querySelectorAll('.product-card-link');
            let visibleCount = 0;

            productCards.forEach(card => {
                const cardCategoriaPrincipal = card.getAttribute('data-categoria-principal');
                console.log('Card categoria:', cardCategoriaPrincipal);
                if (cardCategoriaPrincipal === categoriaPrincipal) {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            console.log('Visible products:', visibleCount);

            // Close menu
            closeMobileFilter();
        });
    });
}

// Initialize on page load
initMobileFilterMenu();

    function initProductsFilters() {
        // Filtrar produtos por subcategoria
        const productCards = document.querySelectorAll('.products-cards .product-card-wrapper');

        function showAllProducts() {
            productCards.forEach(card => card.style.display = '');
        }

        function filterBySubcategory(sub) {
            if (!sub) {
                showAllProducts();
                return;
            }
            productCards.forEach(card => {
                const cardSub = (card.dataset.productSubcategoria || card.dataset.productCategory || '').toLowerCase();
                if (cardSub === sub.toLowerCase()) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Desktop subcategory links
        document.querySelectorAll('.filter-subcategory-link').forEach(link => {
            // avoid duplicate listeners
            if (link._filterInit) return;
            link._filterInit = true;
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sub = this.dataset.subcategoria;
                filterBySubcategory(sub);
            });
        });

        // Mobile subcategory links
        document.querySelectorAll('.mobile-filter-subcategory-link').forEach(link => {
            if (link._filterInit) return;
            link._filterInit = true;
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sub = this.dataset.subcategoria;
                // close mobile menu
                const mobileMenu = document.getElementById('mobile-filter-menu');
                const mobileOverlay = document.getElementById('mobile-filter-overlay');
                if (mobileMenu) mobileMenu.classList.remove('active');
                if (mobileOverlay) mobileOverlay.classList.remove('active');
                document.body.style.overflow = '';
                filterBySubcategory(sub);
            });
        });
    }

    // Initialize immediately
    initProductsFilters();

    // Lightbox removed from products listing — loupe available only on product detail page
</script>
{% endblock %}
